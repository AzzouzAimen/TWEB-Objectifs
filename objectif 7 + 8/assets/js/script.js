// Make these functions globally accessible for index_ajax.js
window.applyRowspans = function () {
  const $rows = $("#teamsTable tbody tr:visible");
  if ($rows.length === 0) return;

  // Reset visibility of all team cells before recalculating
  $("#teamsTable tbody tr .team-col").show().removeAttr("rowspan");

  let i = 0;
  while (i < $rows.length) {
    const currentTeam = $rows.eq(i).data("team");
    let spanCount = 1;
    let j = i + 1;
    while (j < $rows.length && $rows.eq(j).data("team") === currentTeam) {
      spanCount++;
      j++;
    }

    if (spanCount > 1) {
      $rows.eq(i).find(".team-col").attr("rowspan", spanCount);
      for (let k = i + 1; k < i + spanCount; k++) {
        $rows.eq(k).find(".team-col").hide();
      }
    }
    i += spanCount;
  }
};

window.searchTable = function () {
  const teamSearch = $("#searchTeam").val().toLowerCase().trim();
  const memberSearch = $("#searchMember").val().toLowerCase().trim();
  const statusSearch = $("#searchStatus").val().toLowerCase().trim();
  const $rows = $("#teamsTable tbody tr");

  if (!teamSearch && !memberSearch && !statusSearch) {
    $rows.show();
    window.applyRowspans();
    return;
  }

  $rows.each(function () {
    const $row = $(this);
    const team = $row.data("team").toLowerCase();
    const member = $row.data("member").toLowerCase();
    const status = $row.data("status").toLowerCase();
    const teamMatch = !teamSearch || team.includes(teamSearch);
    const memberMatch = !memberSearch || member.includes(memberSearch);
    const statusMatch = !statusSearch || status.includes(statusSearch);

    if (teamMatch && memberMatch && statusMatch) {
      $row.show();
    } else {
      $row.hide();
    }
  });

  window.applyRowspans();
};

$(document).ready(function () {
  // Build the table cells from the data attributes generated by PHP
  function buildTable() {
    const $tbody = $("#teamsTable tbody");
    $tbody.find("tr").each(function () {
      const $row = $(this);
      const team = $row.data("team");
      const member = $row.data("member");
      const status = $row.data("status");

      $row.append($("<td>").addClass("team-col").text(team));
      $row.append($("<td>").text(member));
      $row.append($("<td>").text(status));
    });
    window.applyRowspans();
  }

  // Build the table on page load
  buildTable();

  // Sort functionality
  $("#sortButton").on("click", function () {
    const sortColumn = $("#sortColumn").val();
    const sortOrder = $("#sortOrder").val();
    const $tbody = $("#teamsTable tbody");
    const $rows = $tbody.find("tr").get();

    $rows.sort((a, b) => {
      const valueA = $(a).data(sortColumn);
      const valueB = $(b).data(sortColumn);
      const comparison = valueA.localeCompare(valueB);
      return sortOrder === "asc" ? comparison : -comparison;
    });

    $.each($rows, function (index, row) {
      $tbody.append(row);
    });

    window.applyRowspans();
  });

  // Search functionality
  function searchTable() {
    window.searchTable();
  }

  $("#searchButton").on("click", searchTable);
  $("#searchTeam, #searchMember, #searchStatus").on("keypress", function (e) {
    if (e.which === 13) searchTable();
  });

  // Reset functionality
  $("#resetButton").on("click", function () {
    $("#searchTeam, #searchMember, #searchStatus").val("");
    $("#teamsTable tbody tr").show();
    window.applyRowspans();
  });
});
